<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>CloudForest Guide</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">CloudForest Guide</h1>
</header>
<h1 id="cloudforest-user-guide">CloudForest User Guide</h1>
<p>CloudForest is a collection of phylogenomic tools residing in the workflow application <a href="https://galaxyproject.org/"><strong>Galaxy</strong></a>. Both Galaxy and CloudForest are packaged within a <a href="https://docker.com"><strong>Docker</strong></a> container.</p>
<p>Containers package application, OS and dependency code into images that can be run from variety of computing environments. CloudForest via Docker will run on Linux, Windows and MacOS.</p>
<h2 id="preparing-to-run-cloudforest">Preparing to Run CloudForest</h2>
<h3 id="docker-installation">Docker Installation</h3>
<p>To run CloudForest, you will have to install Docker. Please follow these <a href="https://www.docker.com/products/docker-desktop"><strong>instructions</strong></a> to install Docker for your operating system.</p>
<h3 id="docker-pull-and-run-commands">Docker Pull and Run Commands</h3>
<p>The CloudForest Docker image is stored on <a href="https://hub.docker.com/repository/docker/cloudforestphylogenomics/cloudforest_galaxy"><strong>Docker hub</strong></a>.</p>
<blockquote>
<p><strong>NB: Docker commands are run from the terminal command line.</strong></p>
</blockquote>
<h4 id="pulling-the-image">Pulling the Image</h4>
<p>You can download the image to your computer with the following <a href="https://docs.docker.com/engine/reference/commandline/pull/"><strong>command</strong></a>:</p>
<pre><code>docker pull cloudforestphylogenomics/cloudforest_galaxy:latest</code></pre>
<p>This command contacts Docker hub and pulls down the latest image of CloudForest.</p>
<p>You can verify the download with the command:</p>
<pre><code>docker images</code></pre>
<p>You will see something like this:</p>
<pre><code>cloudforestphylogenomics/cloudforest_galaxy  latest  160a642eee15  4 days ago  2.12GB</code></pre>
<p>The number <em>160a642eee15</em> is an arbitraty ID assigned to the container by Docker. You do not have to use the ID number.</p>
<h4 id="running-a-docker-image">Running a Docker Image</h4>
<p>In general you run any image with the following <a href="https://docs.docker.com/engine/reference/commandline/run/"><strong>command</strong></a>:</p>
<pre><code>docker run hello-world</code></pre>
<p>This is an actual run command that tests your Docker installation.</p>
<p>If Docker is installed correctly you should see the following output:</p>
<pre><code>Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
1. The Docker client contacted the Docker daemon.
2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.
    (amd64)
3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
$ docker run -it ubuntu bash</code></pre>
<h4 id="docker-prune">Docker Prune</h4>
<p>It may be necessary to clean your docker installation periodically. Read about the <a href="https://docs.docker.com/engine/reference/commandline/system_prune/"><strong>prune</strong></a> command in the docker documentation. This command will remove all unused data and docker objects. Be careful using this command especially if you have not moved data files from the container into your local file space.</p>
<h2 id="running-docker-cloudforest">Running Docker CloudForest</h2>
<h3 id="run.sh"><code>run.sh</code></h3>
<p>A simple script <code>run.sh</code> is provided to run the project. To get started with a local instance <em>without</em> data perstitance, run:</p>
<pre><code>./run.sh dev cloudforest_dev</code></pre>
<p>This builds an image named <code>cloudforestphylogenomics/cloudforest_galaxy:dev</code>, and runs it in a local container named <code>cloudforest_dev</code>. You may be prompted to confirm that the script may delete existing images or containers with the same name. To override this prompt, the <code>-d</code> flag may be used.</p>
<p>To run an instance with data persistence, first we need to create a volume, and pass it with <code>-v</code> as an argument to <code>run.sh</code>:</p>
<pre><code>docker volume create cloudforest-volume
./run.sh -v cloudforest-volume dev cloudforest_dev</code></pre>
<p>The <code>-s</code> option can be used to enable SFTP for file-upload, which currently should only be used in a local, single-user context. See the <code>Uploading Files</code> section below.</p>
<h3 id="uploading-files">Uploading Files</h3>
<p>Galaxy documentation <a href="https://galaxyproject.org/tutorials/upload/">recommends</a> only using the basic local file upload for small numbers of files. For many files, or larger files FTP is recommended. Due to some limitations with running an FTP server within Docker, SFTP is a more viable method for uploading files in bulk.</p>
<h4 id="sftp-warning-this-option-comes-with-security-considerations---see-below.">SFTP (Warning: this option comes with security considerations - see below.)</h4>
<p>This should not be used on an host that allows incoming network traffic, over has multiple users. In the current implementation of galaxy-docker from which CloudForest is built, the entire containerized Galaxy installation including uploaded data may be downloaded via SFTP by anyone with an account on the instance. For this reason it is only suitably run on a personal machine, for the time being.</p>
<p>The <code>-s</code> flag for <code>run.sh</code> may be used to enable SFTP on the instance. The SFTP port is forwarded to 8022 only on IP 127.0.0.1, just in case it is run on a publicly accessible host.</p>
<p><a href="https://filezilla-project.org/">FileZilla</a> or <a href="https://man7.org/linux/man-pages/man1/sftp.1.html">sftp</a> may be used to upload files to the instance.</p>
<h4 id="filezilla-steps">FileZilla Steps</h4>
<ol type="1">
<li>Download the FileZilla client from https://filezilla-project.org.</li>
<li>With FileZilla open, click the Site Manager button in the top left corner.</li>
<li>Click <strong>New site</strong> to create a new site and name it however you like, e.g. “CloudForest”.</li>
<li>Select <strong>Protocol</strong> -&gt; <strong>SFTP - SSH File Transfer Protocol</strong>.</li>
<li>Enter <strong>127.0.0.1</strong> for <strong>Host</strong>.</li>
<li>Enter <strong>8022</strong> for <strong>Port</strong>.</li>
<li>Select <strong>Ask for password</strong> for <strong>Logon Type</strong>.</li>
<li>Enter your galaxy username.</li>
<li>Select <strong>OK</strong> and FileZilla will prompt for your password and establish a connection.</li>
</ol>
<p>You should see on the right a hierarchy of directories <code>/export/ftp/&lt;your username&gt;</code>. Navigate to the files on your host machine in the left-hand pane, and drag the files you want to upload to the right-hand pane.</p>
<p>Once the files have been uploaded to the FTP location, they must still be imported into your history. This is done within Galaxy by navigating in the tool pane to <code>Get Data</code> -&gt; <code>Upload File</code> -&gt; <code>Choose FTP file</code>. Here you should see the files you uploaded with FileZilla.</p>
<h4 id="sftp">sftp</h4>
<p><code>sftp</code> is a command-line program for uploading/downloading that is likely already installed if your machine is running MacOS or Linux. File upload can be achieved with the following command:</p>
<pre><code>sftp -P 8022 -o User=&lt;your username&gt; 127.0.0.1 &lt;&lt;&lt; $&#39;put &lt;path to your files&gt;&#39;</code></pre>
<p>File globbing may be used here for the filepath, e.g. <code>/my/text/files/*.txt</code> will upload all <code>.txt</code> files in that directory.</p>
<h3 id="running-with-no-data-persistence">Running with No Data Persistence</h3>
<p>Containers are by default ephemeral applications. When you run CloudForest using the following command no data is saved once the application is stopped.</p>
<blockquote>
<p><strong>NB: No data is saved between invocations using the default command.</strong></p>
</blockquote>
<p>CloudForest is run with the docker run command with additional arguments:</p>
<pre><code>docker run -d -p 8080:80 --name cloudforest -e &quot;GALAXY_DESTINATIONS_DEFAULT=local_no_container&quot; -e &quot;GALAXY_SLOTS=2&quot; cloudforestphylogenomics/cloudforest_galaxy:latest</code></pre>
<p>What are the arguments?</p>
<ul>
<li><p>-d -p 8080:80</p>
<p>CloudForest is a web application and like all web applications it listens on a port. In this case port 80. A docker container must map ports on the local machine (your computer) into the container. The <em><strong>-p</strong></em> argument maps the local port 8080 to the container port 80. You will use the 8080 port address when opening the application via the browser. The <em><strong>-d</strong></em> argument runs CloudForest as a daemon service.</p></li>
<li><p>--name cloudforest</p>
<p>The running container is given a name with this argument. Multiple containers can run at the same time on any one machine. By default each container will be given an id something like <em>63289272e49b</em>. Use the <em><strong>--name</strong></em> argument to give the container a good, memorable name. This name will be used to stop, or if necessary directly access, the container.</p></li>
<li><p>-e “GALAXY_DESTINATIONS_DEFAULT=local_no_container”</p>
<p>The <em><strong>-e</strong></em> flag sets environment variables inside the container. In this case we are telling CloudForest to run all tools within the container. It is possible to run tools on <a href="https://github.com/bgruening/docker-galaxy-stable#Running-on-an-external-cluster-(DRM)">HPC compute nodes or external clusters</a>. Using external clusters is outside the scope of this document.</p></li>
<li><p>-e “GALAXY_SLOTS=2”</p>
<p>This varible starts the application with 2 threads. If you have a local machine with multiple cores, you can increase this number.</p></li>
<li><p>cloudforestphylogenomics/cloudforest_galaxy:latest</p>
<p>This is the docker image. If you have pulled the image, docker will run with the locally cached image. If you have <em>not</em> pulled the image, docker will first pull the image from the docker hub and then run the container.</p></li>
</ul>
<p><strong>This is odd, why would I want to run CloudForest with no data persistence?</strong></p>
<p>Running Docker in this default mode allows for an instance that does not add data to your local machine. If you are exploring data, or learning how to use the tools, and are not yet interested in building a traceable history, this mode is ideal. In addition, if there is a surprising, interesting output you can always download the data from CloudForest to your local OS even in this ephemeral mode.</p>
<h3 id="running-the-image-with-data-persistence">Running the Image with Data Persistence</h3>
<p>Docker does allow for data persistence over time. This is done by mapping local filespace into the container.</p>
<pre><code>docker run -d -p 8080:80 --name cloudforest -v /home/user/galaxy_storage/:/export/ -e &quot;GALAXY_DESTINATIONS_DEFAULT=local_no_container&quot; -e &quot;GALAXY_SLOTS=2&quot; cloudforestphylogenomics/cloudforest_galaxy:latest</code></pre>
<p>The <em><strong>-v</strong></em> option is used for volume mapping.</p>
<pre><code>-v /home/user/galaxy_storage/:/export/</code></pre>
<p>Docker applications are containers running within your host computer operating system. If you are using a Mac, the host OS is macOS and the container’s OS is linux (CloudForest is always run within Ubuntu).</p>
<p>Running CloudForest with the <em><strong>-v</strong></em> option opens a tunnel from the host OS (macOS in the example) into the container OS. In the above example the host path <em>/home/user/galaxy_storage/</em> is directly connected to the container’s folder <em>/export</em>.</p>
<p>When CloudForest is run with the <em><strong>-v</strong></em> option, the database and data files are stored on your local host environment within the path <em>/home/user/galaxy_storage</em>.</p>
<p>You can use any local path you would like (the left hand side of the colon), the <em><strong>/export/</strong></em> path is <strong>mandatory</strong>. CloudForest is built to write all of its data to the container path <em><strong>/export/</strong></em>.</p>
<p>Each time you start CloudForest using the same <em><strong>-v</strong></em> option, CloudForest will use the database and data files found on the local OS path. This gives you data permanence across CloudForest starts and stops.</p>
<p>You can specifiy multiple, unique <em><strong>-v</strong></em> options. In that case you will have completely separate CloudForest data installations existing in your local file space.</p>
<h2 id="using-cloudforest">Using CloudForest</h2>
<blockquote>
<p>NB: Docker commands are run from the terminal command line.</p>
</blockquote>
<p>This is the recommended command for running CloudForest on macOS (assuming the user’s name is <em>jdoe</em>):</p>
<pre><code>docker run -d -p 8080:80 --name cloudforest -v /User/jdoe/galaxy_storage/:/export/ -e &quot;GALAXY_DESTINATIONS_DEFAULT=local_no_container&quot; -e &quot;GALAXY_SLOTS=2&quot; cloudforestphylogenomics/cloudforest_galaxy:latest</code></pre>
<p>This is the recommended command for running CloudForest on a linux distribution (assuming the user’s name is <em>jdoe</em>):</p>
<pre><code>docker run -d -p 8080:80 --name cloudforest -v /home/jdoe/galaxy_storage/:/export/ -e &quot;GALAXY_DESTINATIONS_DEFAULT=local_no_container&quot; -e &quot;GALAXY_SLOTS=2&quot; cloudforestphylogenomics/cloudforest_galaxy:latest</code></pre>
<p>This is the recommended command for running CloudForest on Windows 10 (assuming the user’s name is <em>jdoe</em>):</p>
<pre><code>TODO</code></pre>
<p>It will take a minute or two for CloudForest to start once you invoke the docker run command.</p>
<p>If your computer has more than 4 cores, setting “GALAXY_SLOTS=4” is a good setting.</p>
<ol type="1">
<li><p>Open a browser</p></li>
<li><p>Enter the address<br></p>
<p>http://localhost:8080</p></li>
<li><p>Click on “Login or Register”</p></li>
<li><p>You can register a user name, if more than one person is going to access CloudForest. If not, use</p>
<p><strong>Public name or Email Address</strong>: admin</p>
<p><strong>Password</strong>: admin</p></li>
<li><p>Click on Login</p></li>
</ol>
<p>When you wish to stop the application use the folowing command at the terminal:</p>
<pre><code>docker stop cloudforest</code></pre>
<p>Where <em>cloudforest</em> is the name used in the --name argument.</p>
<h3 id="a-brief-cloudforest-tour">A Brief CloudForest Tour</h3>
<p>This is the initial workspace screen:<br></p>
<p><img src="FirstScreen.png" /></p>
<p>The right panel shows your processing history. Each entry in the history is a file: either imported from your local file space or the results of a computation.</p>
<p>The center panel will contain all the options for a selected tool. You will launch the tool by clicking <strong>Execute</strong> after specifying options.</p>
<p>The left panel contains all the tools available for use.</p>
<p align="center">
◈
</p>
<p>You access all tools from the left panel, click on <strong>CloudForest</strong> to open the subpanel:<br> <img src="Tools.png" /></p>
<p>Click on any tool to show its options:<br> <img src="TreeScaper-Trees.png" /></p>
<p>In this example, the options for the <strong>-trees</strong> argument are made available. The first history entry, <strong>cats_subsampled.boottrees</strong> has been uploaded to CloudForest and is the start of the data analysis.</p>
<p>Clicking on <strong>Execute</strong> starts the compute job. In the right history pane, you can see the four outputs that will be produced from the job run. Once the entries change from gray to green, the job is complete and the outputs are ready for further processing or inspection.</p>
<p>For instance, you can run NLDR on history entry 5 <strong>Distance Matrix from data 1</strong> to generate a non-linear dimension reduction of the generated trees.</p>
<p><img src="Execute.png" /></p>
<p align="center">
◈
</p>
<h4 id="workflows">Workflows</h4>
<p>There are constructed workflows available for use. These workflows string together mutliple tools with common options selected. You can override the configured options before starting a workflow.</p>
<p>Reading from left to right: - Start with a set of bootstrapped trees, you will select the specific input - Generate a distance matrix - Generate a 20D NLDR matrix from the distance matrix - Generate an affinity matrix from the 20D matrix - Run community detection based on the generated affinity matrix</p>
<p>Once the workflow starts, barring errors, it will run until the final output is produced. All intermediate datasets will be saved and will be available for inspection or as inputs to other compute jobs.</p>
<p>There will be ten data sets after the workflow finishes. Each asterix in the tools boxes shown below is a data file.</p>
<p><img src="Workflow_20D.png" /></p>
<p align="center">
◈
</p>
<h3 id="inspect-data-files">Inspect Data Files</h3>
<p>The raw data of a computed data set can be viewed from within CloudForest. On any history entry, click on the eye icon. <img src="eye.png" /></p>
<p>This will open the raw data within a computed data set. The data will appear within the central pane.</p>
<p><img src="raw_data.png" /></p>
<h3 id="visualizations">Visualizations</h3>
<p>CloudForest datasets can be visualized directly from the CloudForest application. Within each data entry, you can click on the <em>Visualize this data</em> button</p>
<p><img src="viz_select.png" /></p>
<p>Then click on the <em>CloudForest Visualizations</em> link in the center pane. This will open the CloudForest visualization application.</p>
<p><img src="viz_categories.png" /></p>
<p>The available plots and visualizations are arranged in three categories: - NLDR Plots - 2D - 3D - High Dimension Plots - Trees and Matrices - Treesets (Newick) - Consensus Tree - Affinity Matrix - Covariance Matrix - Communtiy Detection - CD Results</p>
<p>Click on any dropdown item to visualize the file. For example, choosing <em>NDLR Coordinates: 3D from data 5</em> will produce a fully interactive 3D plot</p>
<p><img src="3dnldr.png" /></p>
<p>In this screen capture the trees have been color coded based on the x-axis. Highlighting a data point will let you know what tree is associated with the point. Click on the data point will open the tree itself.</p>
<p><img src="multi_viz.png" /></p>
</body>
</html>
